!function(e,t){"function"==typeof define&&define.amd?define(["exif-js"],t):"object"==typeof exports?module.exports=t(require("exif-js")):e.CanvasCompress=t(e.EXIF)}(this,function(e){"use strict";function t(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=window.URL||window.webkitURL,o=Math.log(2),h=4,s=.9,u="image/jpeg",c={width:1e3,height:618},g={1:{swap:!1,matrix:[1,0,0,1,0,0]},2:{swap:!1,matrix:[-1,0,0,1,"width",0]},3:{swap:!1,matrix:[-1,0,0,-1,"width","height"]},4:{swap:!1,matrix:[1,0,0,-1,0,"height"]},5:{swap:!0,matrix:[0,1,1,0,0,0]},6:{swap:!0,matrix:[0,1,-1,0,"height",0]},7:{swap:!0,matrix:[0,-1,-1,0,"height","width"]},8:{swap:!0,matrix:[0,-1,1,0,0,"width"]}},f=function p(){var e=this;r(this,p),this.promise=new Promise(function(t,r){e.resolve=t,e.reject=r})},l=function(){function l(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.type,i=void 0===t?u:t,n=e.width,a=void 0===n?c.width:n,o=e.height,h=void 0===o?c.height:o,g=e.quality,f=void 0===g?s:g;r(this,l),f=parseFloat(f);var p={width:parseFloat(a),height:parseFloat(h)};Object.defineProperties(this,{outputType:{get:function(){return i}},outputSize:{get:function(){return p}},outputQuality:{get:function(){return f}}})}return n(l,[{key:"_getOriginalImage",value:function(e){var t=a.createObjectURL(e),r=new Image,i=new f;return r.onload=function(){i.resolve(r)},r.onerror=function(){i.reject("image load error")},r.src=t,i.promise}},{key:"_drawOriginalImage",value:function(r){var i=document.createElement("canvas"),n=i.getContext("2d"),o=new f,h=r.width,s=r.height;return e.getData(r,function(){var u=e.getTag(r,"Orientation")||1,c=g[u],f=c.swap,l=c.matrix;f&&(h=r.height,s=r.width),"string"==typeof l[4]&&(l[4]=r[l[4]]),"string"==typeof l[5]&&(l[5]=r[l[5]]),i.width=h,i.height=s,n.save(),n.transform.apply(n,t(l)),n.drawImage(r,0,0),n.restore(),a.revokeObjectURL(r.src),o.resolve(i)}),o.promise}},{key:"_resizeImage",value:function(e){var t=this.outputSize,r=e.width,i=e.height,n=Math.min(1,t.width/r,t.height/i);return Promise.resolve({source:e,scale:n})}},{key:"_drawImage",value:function(e){var t=e.source,r=e.scale,i=t.getContext("2d"),n=Math.min(h,Math.ceil(1/r/o));r=Math.pow(r,1/n);for(var a=t.width,s=t.height;n--;){var u=a*r|0,c=s*r|0;i.drawImage(t,0,0,a,s,0,0,u,c),a=u,s=c}var g=document.createElement("canvas"),f=g.getContext("2d");return g.width=a,g.height=s,f.drawImage(t,0,0,a,s,0,0,a,s),Promise.resolve(g)}},{key:"_compress",value:function(e){var t=this.outputType,r=this.outputQuality,i=e.width,n=e.height,a=e.toDataURL(t,r),o=atob(a.split(",")[1]).split("").map(function(e){return e.charCodeAt(0)}),h=new Blob([new Uint8Array(o)],{type:t});return Promise.resolve({blob:h,width:i,height:n})}},{key:"process",value:function(e){if(!e)return Promise.reject(new ReferenceError("file blob is required"));if(!e.type.match(/^image/))return Promise.reject(new TypeError("unsupport file type: "+e.type));var t={};return this._getOriginalImage(e).then(function(e){return t.width=e.width,t.height=e.height,e}).then(this._drawOriginalImage.bind(this)).then(this._resizeImage.bind(this)).then(this._drawImage.bind(this)).then(this._compress.bind(this)).then(function(r){return{source:i({blob:e},t),result:i({},r)}})}}]),l}();return l});